# TorchOverlay 企业级重构计划

## 概述
本文档记录TorchOverlay项目的企业级重构计划和进度。

## 重构原则
1. **渐进式重构**：避免大爆炸式重构，分阶段进行
2. **向后兼容**：保持现有功能可用
3. **测试先行**：先编写测试，再重构
4. **持续集成**：确保重构不影响现有功能

## 阶段划分

### 阶段一：基础架构优化（1-2周）
**目标**：建立稳定的基础架构

| 优先级 | 任务 | 状态 | 风险 |
|--------|------|--------|------|
| P0 | 建立测试框架 | 待开始 | 低 |
| P0 | 添加自定义异常体系 | 待开始 | 低 |
| P0 | 统一日志系统 | 待开始 | 中 |
| P0 | 消除重复代码（模型定义） | 待开始 | 低 |
| P1 | 完善类型注解 | 待开始 | 低 |
| P1 | 规范命名 | 待开始 | 中 |

### 阶段二：控制器拆分（2-3周）
**目标**：将app_controller.py拆分为多个专用控制器

| 优先级 | 任务 | 状态 | 风险 |
|--------|------|--------|------|
| P0 | 提取价格计算逻辑到PriceCalculatorService | 待开始 | 中 |
| P0 | 提取OCR流程到RecognitionFlowService | 待开始 | 中 |
| P1 | 创建EventBus解耦组件 | 待开始 | 中 |
| P1 | 实现状态管理器 | 待开始 | 中 |

### 阶段三：配置管理重构（1-2周）
**目标**：建立统一的配置管理系统

| 优先级 | 任务 | 状态 | 风险 |
|--------|------|--------|------|
| P0 | 实现配置热更新 | 待开始 | 中 |
| P0 | 添加配置验证 | 待开始 | 低 |
| P1 | 敏感信息加密 | 待开始 | 中 |
| P1 | 配置文件合并 | 待开始 | 高 |

### 阶段四：性能优化（2-3周）
**目标**：优化关键路径性能

| 优先级 | 任务 | 状态 | 风险 |
|--------|------|--------|------|
| P0 | OCR缓存机制 | 待开始 | 中 |
| P0 | 截图内存优化 | 待开始 | 低 |
| P1 | 窗口缓存 | 待开始 | 低 |
| P1 | 异步价格更新 | 待开始 | 中 |
| P2 | Overlay渲染优化 | 待开始 | 低 |

### 阶段五：文档完善（持续进行）
**目标**：建立完整的文档体系

| 优先级 | 任务 | 状态 | 风险 |
|--------|------|--------|------|
| P0 | 生成API文档 | 待开始 | 低 |
| P0 | 编写架构文档 | 待开始 | 低 |
| P1 | 开发者指南 | 待开始 | 低 |
| P1 | 部署文档 | 待开始 | 低 |

## 进度跟踪

### 已完成任务
- [x] 项目架构分析完成
- [x] 阶段一：基础架构优化
  - [x] 建立测试框架
  - [x] 添加自定义异常体系
  - [x] 创建价格计算服务（消除重复代码）
  - [x] 统一日志系统（替换所有print为logger）
  - [x] 消除重复模型定义（统一使用domain层定义）

### 进行中任务
- [x] 阶段一完成 - 所有P0任务已完成

### 待开始任务
- [ ] 阶段一：完善类型注解和命名规范（P1任务）
- [ ] 阶段二：控制器拆分
- [ ] 阶段三：配置管理重构
- [ ] 阶段四：性能优化
- [ ] 阶段五：文档完善

## 里程碑

| 里程碑 | 时间 | 交付物 | 验收标准 |
|--------|------|--------|----------|
| M1 | 第2周末 | 测试框架、异常体系、统一日志 | 测试覆盖率>20% |
| M2 | 第5周末 | 新控制器架构、事件总线 | app_controller.py <200行 |
| M3 | 第7周末 | 统一配置管理 | 配置热更新可用 |
| M4 | 第10周末 | 性能优化、完整文档 | OCR识别速度提升50% |

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 重构引入新bug | 中 | 高 | 完善测试、渐进式重构 |
| 团队不熟悉新模式 | 低 | 中 | 培训、代码审查 |
| 工期延误 | 中 | 中 | 合理分配任务、预留缓冲 |
| 用户不适应 | 低 | 低 | 保持向后兼容、平滑升级 |

## 参考资料
- 项目架构分析报告（由code-explorer生成）
- SOLID设计原则
- 领域驱动设计（DDD）
- 测试驱动开发（TDD）
