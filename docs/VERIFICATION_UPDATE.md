# 验证功能更新说明

## 更新内容

### 1. 物品ID匹配（优先）

**改进前**: 使用物品中文名称进行匹配
**改进后**: 优先使用物品ID进行匹配，更准确可靠

### 2. 刷新日志监控输出

**改进前**: 刷新事件没有控制台输出
**改进后**: 添加了详细的刷新事件输出

## 详细说明

### 物品ID匹配机制

#### 工作流程

```
1. OCR识别物品（中文名）
   ↓
2. 通过ItemPriceService查询物品ID
   ↓
3. 保存到验证池（包含item_id和item_name）
   ↓
4. 游戏日志检测到购买事件（包含item_id）
   ↓
5. 优先使用item_id进行匹配
   ↓
6. 如果item_id匹配失败，使用item_name备用匹配
```

#### 匹配逻辑

**优先级1：物品ID匹配**
```python
if ocr_record.item_id == buy_event.item_id:
    # 匹配成功
```

**优先级2：物品名称匹配（备用）**
```python
if _match_item_name(ocr_record.item_name, buy_event.item_name):
    # 匹配成功
```

#### 查询物品ID

在 `add_ocr_result` 时自动查询：
1. 从 `item.json` 中精确匹配物品名称
2. 如果未找到，使用价格进行模糊匹配
3. 返回对应的物品ID

#### 控制台输出

```
[验证服务] 添加OCR识别结果: 初火源质 (ID:100300) x1, 价格: 50, 利润: 0.2100
[验证服务] 添加购买事件: 初火源质, 消耗神威辉石: 50
[验证服务] ✓ 找到匹配事件(ID): 时间差=3.2s, 物品=初火源质, ID=100300, 消耗=50
[验证服务] ✓ 验证通过: 初火源质 x1, 利润: 0.21
```

### 刷新日志监控

#### 工作流程

```
1. 游戏日志检测到刷新商店事件
   ↓
2. 解析神威辉石消耗数量
   ↓
3. 添加到验证服务的刷新事件列表
   ↓ 控制台输出
4. 兑换监控服务定期检查（每5秒）
   ↓
5. 保存到 refresh_log.json（自动去重）
   ↓ 控制台输出
```

#### 控制台输出

```
[日志监控] ✓ 检测到刷新商店事件, 消耗神威辉石: 50, 时间: 14:30:30
[验证服务] 添加刷新事件: 消耗 50 神威辉石, 时间: 14:30:30
[兑换监控] ✓ 保存了 1 条刷新记录到 refresh_log.json
```

#### 去重机制

在 `RefreshLogService.add_records` 中：
- 比较时间戳
- 只保存新的刷新事件
- 避免重复记录

## 数据模型更新

### OcrRecognitionRecord

新增字段：
```python
item_id: int | None = None  # 物品ID（通过ItemPriceService查询）
```

数据示例：
```json
{
  "timestamp": "2025-02-13T14:30:40",
  "item_name": "初火源质",
  "item_id": 100300,
  "item_quantity": "1",
  "original_price": 1.0,
  "converted_price": 0.79,
  "profit": 0.21,
  "gem_cost": "50",
  "verified": false,
  "expire_time": "2025-02-13T14:31:40"
}
```

## 优势

### 1. 更准确的匹配

- 物品ID是唯一的，不会因为名称相似而误匹配
- 避免了OCR识别错误导致的匹配失败

### 2. 兼容性

- 保留了物品名称匹配作为备用方案
- 兼容旧数据（没有item_id的记录）

### 3. 完整的监控

- 刷新事件也有完整的日志输出
- 方便调试和问题排查

### 4. 避免重复

- 刷新记录自动去重
- 避免重复保存相同的事件

## 测试验证

### 1. 物品ID匹配测试

1. 识别一个物品
   ```
   [验证服务] 添加OCR识别结果: 初火源质 (ID:100300) x1, 价格: 50, 利润: 0.2100
   ```

2. 购买该物品
   ```
   [日志监控] ✓ 检测到购买事件: 初火源质 x1, 消耗神威辉石: 50, 时间: 14:30:45
   [验证服务] 添加购买事件: 初火源质, 消耗神威辉石: 50
   ```

3. 验证匹配
   ```
   [验证服务] ✓ 找到匹配事件(ID): 时间差=3.2s, 物品=初火源质, ID=100300, 消耗=50
   [验证服务] ✓ 验证通过: 初火源质 x1, 利润: 0.21
   [兑换日志] 成功保存 1 条验证通过的记录
   ```

### 2. 刷新商店测试

1. 在游戏中刷新商店
   ```
   [日志监控] ✓ 检测到刷新商店事件, 消耗神威辉石: 50, 时间: 14:30:30
   ```

2. 验证服务处理
   ```
   [验证服务] 添加刷新事件: 消耗 50 神威辉石, 时间: 14:30:30
   ```

3. 保存到日志
   ```
   [兑换监控] ✓ 保存了 1 条刷新记录到 refresh_log.json
   ```

## 常见问题

### Q: 物品ID未找到怎么办？

A: 系统会使用物品名称作为备用匹配方式：
1. 首先尝试精确匹配名称
2. 然后尝试价格模糊匹配
3. 输出会显示 "(ID:未找到)"

### Q: 刷新记录会重复保存吗？

A: 不会。系统会根据时间戳自动去重，只保存新的刷新事件。

### Q: 如何查看物品ID？

A: 查看控制台输出：
```
[验证服务] 添加OCR识别结果: 初火源质 (ID:100300) x1, 价格: 50, 利润: 0.2100
```

或者查看 `item.json` 文件。

## 总结

### ✅ 改进点

1. **优先使用物品ID匹配** - 更准确可靠
2. **刷新日志监控输出** - 完整的调试信息
3. **自动去重** - 避免重复保存刷新记录
4. **兼容性** - 保留名称匹配作为备用方案

### 📊 性能提升

- 匹配速度更快（整数比较 vs 字符串比较）
- 匹配准确率更高（ID唯一性）
- 避免误匹配

### 🔍 可观测性

- 所有操作都有控制台输出
- 方便调试和监控
- 清晰的匹配过程展示
