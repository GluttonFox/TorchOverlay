# 兑换日志清理说明

## 问题说明

之前的 `exchange_log.json` 文件中保存的是OCR识别结果（未经验证），现在系统已经升级为只显示经过游戏日志验证通过的购买记录。

## 当前行为

### 1. 日志加载
- **新格式** (带 `verified` 字段): 只显示 `verified=true` 的记录
- **旧格式** (不带 `verified` 字段): 显示所有记录（兼容旧数据）

### 2. 数据格式

**旧格式** (OCR识别结果):
```json
{
  "item_name": "初火灵砂",
  "quantity": "60",
  "original_price": 0.06006,
  "converted_price": 0.15375,
  "profit": -0.09369,
  "status": "完成"
}
```

**新格式** (验证通过的购买记录):
```json
{
  "timestamp": "2025-02-13T14:30:45",
  "item_name": "初火源质",
  "item_id": 100300,
  "item_quantity": "1",
  "original_price": 1.0,
  "converted_price": 0.79,
  "profit": 0.21,
  "gem_cost": 50,
  "ocr_timestamp": "2025-02-13T14:30:40",
  "log_timestamp": "2025-02-13T14:30:45",
  "verified": true
}
```

## 清理旧数据

### 方法一：使用UI清空（推荐）

1. 打开兑换日志窗口
2. 点击"清空"按钮
3. 确认清空操作

### 方法二：手动删除文件

1. 关闭应用
2. 删除 `exchange_log.json` 文件
3. 重新启动应用

### 方法三：保留验证通过的记录

如果想保留一些已确认的记录，可以手动编辑 `exchange_log.json` 文件：

1. 打开 `exchange_log.json`
2. 删除未验证的记录（没有 `verified` 字段或 `verified=false`）
3. 保存文件

## 系统工作流程

```
1. OCR识别物品
   ↓
2. 添加到验证池 (ocr_recognition_log.json)
   ↓
3. 游戏日志监控检测到购买事件
   ↓
4. 交叉验证（时间、神威辉石、物品名称）
   ↓
5. 验证通过 → 保存到 exchange_log.json
   ↓
6. 兑换日志窗口显示验证通过的记录
```

## 如何验证系统工作

### 1. 测试购买

1. 在游戏中识别一个物品
2. 实际购买该物品（确认神威辉石消耗）
3. 等待最多30秒（验证时间窗口）
4. 打开兑换日志窗口
5. 应该能看到该物品出现在列表中

### 2. 查看验证日志

查看应用日志输出，应该能看到类似的信息：
```
添加OCR识别结果到验证服务: 初火源质
找到匹配事件: 时间差=5.2s, 物品=初火源质, 消耗=50
验证通过: 初火源质 x1, 利润=0.21
兑换记录已保存到exchange_log.json
```

## 常见问题

### Q: 为什么我的兑换记录没有显示？

A: 可能的原因：
1. 购买事件未在游戏日志中检测到（检查游戏日志路径）
2. 时间窗口超过30秒（OCR识别和购买之间太久）
3. 神威辉石消耗量不匹配
4. 物品名称无法匹配

### Q: 旧格式的记录还能看到吗？

A: 可以。系统会继续显示旧格式的记录（兼容性），但建议清理后重新开始。

### Q: 如何查看所有OCR识别记录？

A: 查看 `ocr_recognition_log.json` 文件，这里保存了所有的OCR识别结果，包括未验证的。

### Q: 清空日志会影响验证功能吗？

A: 不会。验证功能会继续正常工作，新验证通过的记录会被保存。

## 建议

1. **定期清理**: 建议定期清理旧的未验证记录
2. **验证测试**: 在使用前先测试一次完整的购买流程
3. **日志查看**: 定期查看应用日志，了解验证状态
4. **备份数据**: 如需保留历史数据，定期备份日志文件
